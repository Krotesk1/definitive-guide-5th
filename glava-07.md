---
description: Внешние подключения
---

# Глава 7

> _Вы не всегда можете контролировать то, что происходит снаружи. Но вы всегда можете контролировать то, что происходит внутри._ 
>
> -- Уэйн Дайер

В предыдущих главах мы рассмотрели много важной информации, которая необходима для работы системы Asterisk. Однако нам еще предстоит обсудить то, что жизненно важно для любой АТС: а именно, подключение ее к внешнему миру. В этой главе мы обсудим внешние подключения.

Новаторская архитектура Asterisk была знаменатлеьной в значительной степени из-за того, что она рассматривает все типы каналов как равные. Это отличается от традиционной АТС, где транки \(которые соединяют с внешним миром\) и расширения \(которые соединяются с пользователями и ресурсами\) логически разделены. Тот факт, что диалплан Asterisk обрабатывает все каналы аналогичным образом означает, что в системе Asterisk вы можете очень легко выполнить то, что гораздо сложнее \(или невозможно\) достичь на традиционной АТС.

Однако, эта гибкость имеет цену. Поскольку система по своей сути не знает разницы между внутренним ресурсом \(например, телефонным аппаратом\) и внешним \(например, каналом телефонной связи\), вы должны убедиться, что ваш диалплан обрабатывает каждый тип ресурса соответствующим образом.

## Основы транкинга

Целью _транкинга_ является обеспечение общего соединения между двумя объектами. У деревьев есть стволы \(англ. trunks\), и все, что проходит между корнями и листьями, происходит через ствол. Железные дороги используют термин "магистраль \(trunks\)" для обозначения основной линии, которая соединяет фидерные линии вместе.

В телекоммуникациях транк соединяет две системы вместе. Операторы связи используют транки \(магистрали\) для подключения своих сетей друг к другу. В АТС линии, которые соединяют АТС с внешним миром \(с точки зрения АТС\), обычно называются транками \(хотя сами операторы связи обычно не считают их транками\). С технической точки зрения определение транка не так ясно, как это было раньше \(транки АТС использовали совершенно другую технологию от станционных линий, но теперь обе, как правило, являются SIP\), но как концепция, транки по-прежнему важны. С SIP все технически одноранговое, поэтому с точки зрения технологии больше нет такой вещи, как транк \(или, возможно, точнее сказать, что все является транком\). С функциональной точки зрения все еще полезно иметь возможность различать ресурсы VoIP, которые подключаются к внешнему миру \(транки \(магистрали\), схемы и т.д.\) и средства IP-телефонии подключенных конечных пользователей \(радиостанции, устройства, расширения, телефонные трубки, телефоны и т.д.\).

В УАТС Asterisk у вас могут быть транки, которые идут к вашему VoIP-провайдеру для междугородних звонков внутри страны, транки для звонков за границу и транки, которые соединяют ваши офисы вместе. Эти транки могут фактически работать через одно и то же сетевое соединение, но в диалплане вы можете относиться к ним совершенно по-разному. У вас даже может быть транк в Asterisk, который просто зацикливается на себе \(обычно это какой-то хитрый хак, который решает некоторую проблему с пространством имен или CDR, которую не удалось решить другим способом\).

## Фундаментальный диалплан для исходящих соединений

В традиционной АТС доступ к внешним линиям обычно осуществляется с помощью кода доступа, который необходимо набрать перед номером.[1](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407857960) Для этой цели обычно используется цифра 9.

В Asterisk аналогично можно назначить 9 для маршрутизации внешних вызовов, но поскольку диалплан Asterisk намного более интеллектуальный, на самом деле нет необходимости заставлять пользователей набирать 9 перед вызовом. Как правило, у вас будет диапазон номеров для вашей системы \(скажем, 100-199\) и диапазон кодов функций \(от \*00 до _\*_99\). Все, что находится за пределами этих диапазонов и соответствует шаблону набора номера для вашей страны или региона и может рассматриваться как внешний вызов.

Если у вас есть один оператор, обеспечивающий всю внешнюю маршрутизацию, то вы можете обрабатывать свой внешний набор через несколько простых совпадений шаблонов. Пример в этом разделе действителен для североамериканского плана нумерации \(NANP\). Если ваша страна не входит в NANP \(который обслуживает Канаду, США и многие страны Карибского бассейна\), вам понадобится другой шаблон соответствия.

Раздел `[globals]` содержит две переменные, названные `LOCAL` и `TOLL`.[2](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407852440) Целью этих переменных является упрощение управления вашим диалпланом, если вам когда-либо понадобится изменить провайдера. Они позволяют внести одно изменение в диалплан, которое повлияет на все места, где указан данный канал:

```text
[globals]
; Эти каналы одинаковы для asterisk, как и любая конечная точка PJSIP, 
; поэтому они будут настроены аналогично телефонным аппаратам. 
; Каждый поставщик услуг будет иметь свои собственные требования к конфигурации 
; (хотя все они будут похожи)
LOCAL=PJSIP/my-itsp
TOLL=PJSIP/my-other-itsp
```

Раздел `[external]` содержит фактический код диалплана, который распознает набранные номера и передает их в приложение `Dial()`: [3](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407848792)

```text
[external]
exten => _NXXNXXXXXX,1,Dial(${LOCAL}/${EXTEN}) ; 10-значный шаблон для NANP
exten => _NXXXXXX,1,Dial(${LOCAL}/${EXTEN}) ; 7-значный шаблон NANP
exten => _1NXXNXXXXXX,1,Dial(${TOLL}/${EXTEN}) ; шаблон международного направления 
; для NANP
exten => _011.,1,Dial(${TOLL}/${EXTEN}) ; Шаблон международного вызова,
; сделанного из NANP
; Этот раздел функционально совпадает с приведенным выше разделом.
; Это для людей, которым нравится набирать '9' для их звонков.
exten => _9NXXNXXXXXX,1,Dial(${LOCAL}/${EXTEN:1})
exten => _9NXXXXXX,1,Dial(${LOCAL}/${EXTEN:1})
exten => _91NXXNXXXXXX,1,Dial(${TOLL}/${EXTEN:1})
exten => _9011.,1,Dial(${TOLL}/${EXTEN:1})
```

В любом контексте, который будет использоваться комплектами или пользовательскими устройствами, вы будете использовать директиву `include=>`, чтобы разрешить доступ к контексту `external`:

```text
[sets]
include => external
```

{% hint style="warning" %}
**Предупреждение**

Крайне важно, чтобы вы не включали доступ к внешним линиям в любом контексте, который может обрабатывать входящий вызов. Риск здесь заключается в том, что фишинговый бот может в конечном итоге получить доступ к вашим исходящим транкам \(вы будете удивлены тем, насколько эти фишинговые боты распространены\).

_**Мы не можем не подчеркнуть, насколько важно, чтобы вы гарантировали, что никакой внешний ресурс не может получить доступ к вашим платным линиям.**_
{% endhint %}

## ТфОП

Телефонная сеть общего пользования \(ТфОП, на англ. PSTN\) существует уже более ста лет. Это предшественник многих технологий, которые формируют наш мир сегодня, от интернета до MP3-плееров.

Использование линий ТфОП старой школы в системах Asterisk больше не является распространенным явлением. Технические сложности, затраты и ограничения устаревшей технологии оправданы только в ситуациях, когда надежное подключение к интернету недоступно \(и даже когда традиционные линии являются проблематичным выбором\). Даже сами операторы связи в значительной степени перешли на VoIP для своих внутренних транков.

{% hint style="info" %}
**ТфОП пора на пенсию**

Больше, чем любой технический фактор, пожалуй, самым значительным гвоздем в гробу ТфОП является тот факт, что большинство технических экспертов в области традиционной телефонии близки или достигли пенсионного возраста, и современные дети не интересуются такими вещами. Суть в том, что вы все чаще обнаружите, что поставщики услуг больше не имеют квалифицированного персонала, необходимого для развертывания традиционных услуг ТфОП. Все крутые ребята изучают VoIP \(который в конечном счете является просто сетевой технологией\), и все операторы связи делают все возможное и самое яркое в сфере бизнеса VoIP/SIP.

Таким образом, хоть раньше и было правдой, что вы не можете обойти схему PRI для надежности, это уже не так. На самом деле, многие компании поставляют схемы PRI через SIP-соединение, которое кладж Asterisk не использует.
{% endhint %}

Там, где ТфОП все еще может оставаться в силе в течение нескольких лет - это телефонные номера. Если бы VoIP был изобретен без предшествующего ему ТфОП маловероятно, что когда-либо было бы изобретено что-то вроде телефонного номера. Тем не менее, они у нас есть, и мы их используем, и причина, по которой мы делаем это, возможно, не столько из-за какой-либо полезности, которую они обеспечивают, а скорее из-за того, что они управляются сложным, многонациональным консорциумом органов по стандартизации и кураторами, которые обеспечивают целостность глобального плана маршрутизации вызовов.

Чтобы оценить это в перспективе, возможно, стоит подумать о том, что если бы интернет разработал телефонную сеть \(а телефонные звонки были такими же бесплатными, как электронная почта\), все наши SIP-телефоны, вероятно, звонили бы весь день с одним спам-звонком за другим. Это все еще происходит, но значительно уменьшается из-за того, что телефонный звонок стоит денег, и даже если он стоит всего лишь копейки, этого достаточно, чтобы не допустить попадания в игру большей части бессмысленного спама.

Еще одной особенностью ТфОП является соответствие стандартам и совместимость. Если вы посмотрите на любой интернет-голосовой продукт, он либо является проприетарным, огороженным садами, либо управляется сообществом и не сможет получить какую-либо полезную тягу. Мы считаем, что это не изменится до тех пор, пока не будет создан какой-то механизм доверия, который гарантирует проверку личности входящих абонентов каким-то широко признанным органом.

### Традиционные транки ТфОП

{% hint style="info" %}
**Примечание**

Этот раздел был написан как дань уважения телекоммуникационной отрасли и истории самой Asterisk. Отчасти это связано с тем, что раз Asterisk мог взаимодействовать со столькими различными типами линий старой школы, потому он и добился раннего успеха. В наши дни использование этих старых линий по большей части исчезло в истории.
{% endhint %}

Существует два типа фундаментальных технологий, которые используются поставщиками услуг ТфОП для предоставления телефонных линий: аналоговые и цифровые.

#### Аналоговая телефония

Первые телефонные сети были полностью аналоговыми. Звуковой сигнал, который вы сгенерировали своим голосом, использовался для генерации электрического сигнала, который передавался на другой конец провода. Электрический сигнал имел те же характеристики, что и производимый звук.

Аналоговые линии имеют несколько характеристик, отличающих их от других линий, которые вы можете подключить к Asterisk:

* Отсутствует сигнальный канал — сигнализация состояния линии является электромеханической, а адресация осуществляется с использованием внутриполосных звуковых сигналов.
* Наблюдение за отключением обычно задерживается на несколько секунд и не является полностью надежным.
* Контроль дальнего конца минимален \(например, контроль ответа отсутствует\).
* Различия в линиях означают, что звуковые характеристики будут варьироваться от линии к линии и потребуют настройки.

Входящие аналоговые линии, которые вы захотите подключить к системе Asterisk, должны быть подключены к порту Foreign eXchange Office \(FXO\). Поскольку в любом стандартном компьютере не существует такого понятия, как порт FXO, то перед подключением традиционных аналоговых линий системе должен быть предоставлен какой-либо порт FXO. Такие компании, как Digium и Sangoma предлагают такие карты, но вы также можете приобрести устройство SIP, которое предоставляет такие порты.

{% hint style="danger" %}
**FXO и FXS**

Для любой аналоговой линии есть два конца: офис \(как правило, центральный офис ТфОП\) и станция \(как правило, телефон, но также может быть карта, такая как модем или линейная карта в АТС\).

Центральный офис отвечает за:

* Питание на линии \(номинально 48 Вольт постоянного тока\)
* Напряжение звонка \(номинально 90 Вольт переменного тока\)
* Предоставление гудка \(сигнала ответа станции\)
* Обнаружение состояния трубки \(положена или поднята\)
* Отправка дополнительной сигнализации, такой как идентификатор вызывающего абонента \(Caller ID\)

Станция отвечает за:

* Обеспечение звонка \(или, по крайней мере, возможности каким-то образом обрабатывать напряжение звонка\)
* Предоставление номеронабирателя \(или какой-либо способ отправки DTMF\)
* Предоставление рычажного переключателя для указания состояния линии

Порт Foreign eXchange \(FX\) _называется тем, к чему он подключается_, а не тем, что он делает. Так, например, порт Foreign Exchange Office \(FXO\) на самом деле является станцией: он соединяется с центральным офисом. Порт Foreign eXchange Station \(FXS\) - это фактически порт, который предоставляет услуги центрального офиса \(другими словами, вы бы подключили аналоговый аппарат к порту FXS\).

Обратите внимание, что переход с FXO на FXS - это не то, что вы можете сделать просто изменением настроек. Порты FXO и FXS требуют совершенно другой электроники.

Это старая школа, ребята. Вы можете запускать старые телефоны возрастом более 100 лет с порта FXS!
{% endhint %}

Мы не рекомендуем использовать аналоговые транки в системе Asterisk. Их конфигурация и использование выходят за рамки данной книги.[4](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407792344)

#### Цифровая телефония

Цифровая телефония была разработана для преодоления многих ограничений аналоговой. Некоторые из преимуществ цифровых линий включают:

* Отсутствие потери амплитуды на больших расстояниях
* Снижение уровня шума на линиях \(особенно на междугородних дистанциях\)
* Возможность выполнять более одного вызова через физический канал
* Более быстрая настройка вызова и разъединение
* Более богатая сигнальная информация \(особенно при использовании ISDN\)
* Более низкая стоимость для поставщиков услуг
* Более низкая цена для клиентов \(на более высоких плотностях\)

Было несколько фундаментальных цифровых линий, которые получили широкое признание в телекоммуникационной отрасли:

T1 \(24 канала\)

Используется в Канаде и США \(в основном для ISDN-PRI\)[5](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407778472)

E1 \(32 канала\)

Используется в остальном мире \(ISDN-PRI или MFC/R2\)

BRI \(2 канала\)

Используется для линий ISDN-BRI \(Евро-ISDN\)

Обратите внимание, что физическая линия может быть дополнительно определена протоколом, работающим по схеме. Например, T1 может использоваться для ISDN-PRI или CAS, а E1 может использоваться для ISDN-PRI, CAS или MFC/R2.

Трудно обосновать использование этих типов линий. По сравнению с протоколами VoIP, они стали дорогими, сложными и несколько негибкими. Если вам нужно подключить такие линии к системе Asterisk, мы рекомендуем какое-то шлюзовое устройство для преобразования линии в SIP, а затем подключиться через SIP к вашей системе Asterisk. Если вам нужна система с одним шасси, такие компании как Digium и Sangoma предлагают цифровые карты ТфОП, которые могут быть установлены непосредственно на ваш сервер Asterisk; они подключаются к Asterisk через драйвер канала DAHDI. Использование этой технологии выходит за рамки данной книги.[6](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407773192)

## VoIP

По сравнению с длительной историей телекоммуникационной отрасли, [7](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407767752) VoIP по-прежнему является относительно новой концепцией. За столетие или около того до появления VoIP единственным способом подключить вас к ТфОП было использование каналов, предоставленных для этой цели вашей местной телефонной компанией. Теперь же VoIP позволяет устанавливать соединения между конечными точками без участия ТфОП \(хотя в большинстве сценариев VoIP в какой-то момент все равно будет присутствовать компонент ТфОП, особенно если используется традиционный телефонный номер E.164\). ТфОП по-прежнему контролирует телефонные номера и мы будем использовать их до тех пор, пока кто-нибудь не придумает механизм адресации на основе интернета, который не будет подвергаться злоупотреблениям, как электронная почта.[8](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407766216)

### Преобразование сетевых адресов \(NAT\)

Если вы собираетесь использовать VoIP через любой вид глобальной сети \(например, интернет\), вы будете иметь дело с брандмауэрами и довольно часто с преобразованием сетевых адресов \(NAT\).[9](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407758680) Базовое понимание того, как протоколы SIP и RTP работают вместе для создания VoIP-вызова может быть полезно в понимании и отладке функциональных проблем \(таких как проблема “односторонней слышимости” часто возникающая при ошибках конфигурации NAT\). NAT позволяет использовать один внешний IP-адрес совместно несколькими устройствами за маршрутизатором. Поскольку NAT обычно обрабатывается в брандмауэре, он также является частью уровня безопасности между частной сетью и интернетом.

VoIP-вызов с использованием SIP не состоит только из сигнальных сообщений для настройки вызова \(часть SIP-соединения\). Он также требует потоков RTP \(медиапотоки\), которые несут фактическое аудио соединение, [10](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407755912) как показано на Рисунке 7-1.

![&#x420;&#x438;&#x441;&#x443;&#x43D;&#x43E;&#x43A; 7-1. SIP &#x438; RTP](.gitbook/assets/0%20%283%29.png)

Использование отдельного протокола для передачи звука - это то, что может сделать обход NAT трудным для VoIP-соединений, особенно если удаленные телефоны находятся за одним NAT, а УАТС - за другим. Проблема вызвана тем фактом, что в то время как SIP-сигнализация обычно разрешена в брандмауэрах на обоих концах, потоки RTP не могут быть распознаны как часть сеанса SIP, и, таким образом, будут проигнорированы или заблокированы, как показано на Рисунке 7-2. Эффект блокировки одного или обоих потоков RTP заключается в том, что пользователи будут жаловаться, что они видят, что их вызовы проходят, и могут отвечать на них, но не могут слышать \(или не могут быть услышаны\).

![Figure 7-2. &#x411;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x430; RTP &#x431;&#x440;&#x430;&#x43D;&#x434;&#x43C;&#x430;&#x443;&#x44D;&#x440;&#x43E;&#x43C;](.gitbook/assets/1%20%282%29.png)

В этом разделе мы обсудим некоторые методы, которые вы можете использовать для устранения проблем, вызванных NAT. Существует два различных сценария, которые необходимо рассмотреть, каждый из которых требует определения параметров в файле _pjsip.conf_. Проблемы NAT могут быть раздражающими при устранении неполадок, поскольку в продакшене существует множество различных типов брандмауэров и множество различных способов их настройки.

В общем, вы захотите добавить следующее в разделы транспорта вашего файла _/etc/asterisk/pjsip.conf_:

```text
[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0
local_net=x.x.x.x/xx ; IP/CIDR вашей внутренней сети
external_media_address=x.x.x.x ; Внешний IP-адрес для использования в обработке RTP
external_signaling_address=x.x.x.x ; Внешний адрес для SIP-сигнализации
```

{% hint style="info" %}
**Примечание**

Если вы хотите узнать внешний адрес вашей УАТС, выполните следующие действия из командной строки:

`$ dig +short myip.opendns.com @resolver1.opendns.com`
{% endhint %}

Вероятно, безопасно устанавливать эти параметры для всех сценариев, но будьте готовы экспериментировать, комментируя настройки и перезагружая PJSIP для тестирования различных сценариев.

#### Устройства за NAT

Если ваши телефонные аппараты находятся за удаленным NAT, в таблице `ps_endpoints` вашей базы данных могут быть параметры, которые следует настроить из настроек по умолчанию. Вам нужно будет поэкспериментировать с изменением следующих значений между `yes` и `no`. Там может быть много различных комбинаций возможно.

```text
MySQL> update ps_endpoints set rtp_symmetric='yes',force_rport='yes',rewrite_contact='yes'
```

Другие параметры, которые вы можете посмотреть, включают `media_address` и `direct_media`.

При внесении изменений учитывайте значения по умолчанию. Если вы сомневаетесь - установите значение поля, которое вы изменили на `NULL`, так как это фактически вернет его к значению по умолчанию.

{% hint style="success" %}
**Сохранение удаленного брандмауэра открытым**

Иногда возникает проблема с SIP-телефоном, когда телефон регистрируется и функционирует при первой загрузке, но затем он внезапно становится недоступным. Что часто происходит здесь - удаленный брандмауэр, не видя никакой активности, поступающей от устройства, закрывает внешнее соединение с телефоном, и таким образом, АТС теряет возможность подавать сигнал на его вызов. Эффект заключается в том, что если АТС попытается отправить вызов на телефон, он не сможет подключиться \(удаленный брандмауэр отклонит соединение\). Если, с другой стороны, пользователь делает вызов, в течение нескольких минут устройство снова сможет принимать входящие вызовы. Естественно, это может вызвать много путаницы для пользователей.

Относительно простое решение этой проблемы[11](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407725320) включает в себя установку таймера регистрации на удаленном телефоне на достаточно низкое значение, которое будет стимулировать соединение каждую минуту или около того, и, таким образом, убедить брандмауэр, что этому соединению может быть позволено существовать на некоторое время дольше. Это небольшой хак, но он оказался успешным. Проблема с предложением универсального решения заключается в том, что существует множество различных моделей брандмауэров, от недорогих устройств потребительского класса до сложных контроллеров границ сеанса, и это одно из немногих решений, которое, по-видимому, надежно решает проблему почти во всех случаях.

Этот подход лучше всего подходит для небольших систем \(менее 100 телефонов\). Большая система с сотнями или тысячами телефонов не будет хорошо обслуживаться этим решением, так как будет увеличена нагрузка на систему из-за почти постоянного потока регистраций с удаленных телефонов. В таком случае необходимо будет более тщательно продумать общую конструкцию \(например, вместо Asterisk можно было бы использовать выделенный сервер регистратора для обработки регистрационного трафика\).

В идеальном мире вы сможете указать конкретную модель брандмауэра и разработать конфигурацию для этих брандмауэров, которая обеспечит правильную обработку вашего SIP-трафика. На самом деле, вы столкнетесь не только с разными моделями брандмауэров, но даже с разными версиями прошивки для одной и той же модели брандмауэра.
{% endhint %}

#### Asterisk за NAT

Во-первых, мы должны сказать вам, что размещение вашей АТС за NAT не рекомендуется. Гораздо лучше обеспечить брандмауэр без уровня NAT \(особенно если у вас есть конечные точки, которые не находятся в той же сети, что и УАТС\).

Если вы застряли в работе с АТС за NAT, вам нужно будет поработать с вашей сетевой командой, чтобы убедиться, что компоненты NAT правильно обрабатываются вашим устройством NAT \(как правило брандмауэром\). Если они не обладают достаточными навыками в этом отношении, Вам могут потребоваться услуги внешнего консультанта, который обладает навыками обхода NAT для трафика SIP/RTP. Как мы уже говорили, нахождение вашей АТС за NAT не рекомендуется.

Как правило, конечные точки также будут находиться за NAT, и, таким образом, у вас будет сценарий с двойным NAT, который, вероятно, потребует нескольких часов пререканий с различными настройками не только в Asterisk, но и в брандмауэре чтобы добиться успеха. Помните - очень важно чтобы вы проверяли звук в обоих направлениях; недостаточно просто проверить, что звонки можно набирать и отвечать.

В сценарии, где нет выбора, кроме как использовать двойной NAT, мы рекомендуем выяснить, можно ли использовать VPN между УАТС и удаленными конечными точками. Во многих случаях его будет легче настроить в конечном итоге. Мы хотели бы сказать, что есть простой и надежный способ гарантировать, что он работает во всех случаях, но, к сожалению, нет.

Вы также можете изучить использование технологий помощи с NAT, таких как STUN, TURN и ICE. Подробности этого выходят за рамки данной книги, так как они требуют внешних серверов, но многие люди имели успех с этими протоколами, где другие методы потерпели неудачу.

### Терминация и инициирование ТфОП

Передача вызовов между средой VoIP и ТфОП требует какого-то шлюза для преобразования сигнализации VoIP \(обычно SIP\) в нечто совместимое с протоколами ТфОП. Эти процессы называются _инициированием_ и _терминацией_ \(Рисунок 7-3\).

![&#x420;&#x438;&#x441;&#x443;&#x43D;&#x43E;&#x43A; 7-3. &#x418;&#x43D;&#x438;&#x446;&#x438;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x438; &#x442;&#x435;&#x440;&#x43C;&#x438;&#x43D;&#x430;&#x446;&#x438;&#x44F; &#x422;&#x444;&#x41E;&#x41F;](.gitbook/assets/2%20%282%29.png)

Люди часто путают термины _инициирование_ и _терминация_ относительно того, что есть что. Для нас полезно помнить, что, поскольку ТфОП уже существовал когда появился VoIP, термины развивались по отношению к нему. В идеале процессы, вероятно, должны называться _инициирование_ ТфОП и _терминация_ ТфОП, и мы рекомендуем вам запомнить их таким образом.[12](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407704584)

#### Терминация ТфОП

До тех пор, пока VoIP полностью не заменит ТфОП будет необходимость подключения вызовов из VoIP-сетей к телефонной сети общего пользования. Этот процесс называется _терминацией_ \(Рисунок 7-4\).

![&#x420;&#x438;&#x441;&#x443;&#x43D;&#x43E;&#x43A; 7-4. &#x422;&#x435;&#x440;&#x43C;&#x438;&#x43D;&#x430;&#x446;&#x438;&#x44F; &#x422;&#x444;&#x41E;&#x41F;](.gitbook/assets/3.png)

Хотя вы можете сконструировать систему Asterisk для работы в качестве шлюза терминации \(используя некоторые интерфейсы ТфОП\), на практике вы с большей вероятностью будете использовать _поставщика услуг интернет-телефонии_ \(ITSP, также иногда называемый _оператором VoIP_\) для терминации ваших телефонных звонков. Интернет-провайдеры обычно вкладывают огромные инвестиции в инфраструктуру и вам будет трудно сделать лучше не тратя кучу денег. Интернет-провайдеры сделали терминацию недорогой, поэтому трудно сделать бизнес-кейс для того, чтобы сделать это самостоятельно.

{% hint style="success" %}
Если вам действительно нужно подключить систему Asterisk непосредственно к ТфОП, вам потребуется следующее:

* Соответствующая линия\(и\) от тел.комп. ТфОП \(аналоговая, BRI, PRI, SS7, MFC/R2 и т.д.\)
* Подходящее оборудование для подключения к этой линии \(FXO, BRI, T1, E1 и т.д.\)
* Эзоподавление \(аппаратное или программное\)
* Навыки, необходимые для правильной настройки вашего оборудования для оператора, с которым вы имеете дело \(есть множество вариантов каждой из этих типов линий, и может быть трудно даже для тех, кто хорошо знает технологию\)[13](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407692712)

Кроме того, вам часто придется обрабатывать гораздо более сложную логику маршрутизации, которая учитывает такие вещи, как география, корпоративная политика, стоимость, доступные ресурсы и т.д.
{% endhint %}

Для того, чтобы отправить ваши вызовы на ITSP, ваш диалплан должен выглядеть примерно так:

```text
; Для систем NANP
[to-pstn] ; Да, мы проходим через ITSP, но ТфОП - это наш пункт назначения
exten => _1NXXNXXXXXX.,1,Dial(${TOLL}/${EXTEN}) ;  код страны плюс номер телефона
; Добавляем '1' и отправляем
exten => _NXXNXXXXXX.,1,Dial(${LOCAL}/1${EXTEN}) ; код страны плюс номер телефона
; Отбрасываем '011' и отправляем
exten => _011X.,1,Dial(${TOLL}/${EXTEN:3}) ; код страны плюс номер телефона
; Вызов экстренных служб
exten => 911,1,Dial(${LOCAL}/911) ; определение этого потребует информации от вашего оператора

; Большая часть остального мира
[to-pstn]
; Убрать префикс NDD, добавить код страны и отправить
exten => _0X.,1,Dial(${TOLL}/<добавить сюда код страны>${EXTEN:1})
; Убрать префикс IDD и отправить
exten => _00X,1,Dial(${LOCAL}/${EXTEN:2}) ; код страны плюс номер телефона
; Вызов экстренных служб (и других служб)
exten => 11X,1,Dial(${LOCAL}/${EXTEN}) ; для определения этого потребуется информация от вашего оператора
```

{% hint style="warning" %}
**Предупреждение**

Учитывая, что большинство каналов ТфОП позволит вам набрать любой номер в любой точке мира, и учитывая, что вы будете платить за все понесенные расходы, мы не можем лишний раз не подчеркнуть важность безопасности на любой машине шлюза, которая обеспечивает терминацию ТфОП. Преступники прикладывают много усилий для взлома телефонных систем \(особенно плохо защищенных систем Asterisk\), и если вы не уделите пристального внимания всем аспектам безопасности, то станете жертвой мошенничества. Это лишь вопрос времени.

_Не допускайте никаких незащищенных VoIP-соединений в любой контекст, содержащий терминацию ТфОП._
{% endhint %}

Терминация как правило будет более сложной, чем мы описали здесь — даже если вы используете ITSP в качестве своего оператора, но основная концепция довольно проста: сопоставьте шаблон номера, который ваши пользователи могут набрать, подготовьте его для оператора, удалив или добавив необходимые цифры, и отправьте вызов соответствующей конечной точке PJSIP \(транку\). Мы здесь только обсудили диалплан; в более позднем разделе мы обсудим, как настроить SIP-транки для передачи этого трафика.

#### Инициирование ТфОП

Вы также можете принимать звонки от ТфОП в свою сеть VoIP. Процесс выполнения этого обычно называют _инициированием_. Это просто означает что вызов инициирован в ТфОП \(Рисунок7-5\).

![&#x420;&#x438;&#x441;&#x443;&#x43D;&#x43E;&#x43A; 7-5. &#x418;&#x43D;&#x438;&#x446;&#x438;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x422;&#x444;&#x41E;&#x41F;](.gitbook/assets/4.png)

Для того, чтобы обеспечить инициирование, требуется номер телефона.

В старые добрые времена, когда VoIP и Asterisk были молоды, для людей было довольно распространено обрабатывать подключение линии к ТфОП самостоятельно, используя аналоговые или цифровые транки, предоставляемые местной телефонной компанией. По большей части этот тип соединения теперь обрабатывается ITSP, и вам просто нужно подключить вашу систему к VoIP-оператору через SIP-транк.

Телефонные номера — при использовании в целях инициирования обычно называются DID'ами \(номера Direct Inward Dialing\). Ваш оператор связи отправит вызов вниз по каналу в вашу систему и передаст DID \(или специальные полученные цифры в некоторых случаях [14](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html#idm46178407677720)\), которые будет интерпретировать диалплан Asterisk. Другими словами, вам понадобится контекст диалплана, который принимает входящие вызовы от вашего оператора, с расширениями или шаблонами, которые будут коррелировать с вашими DID.

Чтобы принять вызов по линии VoIP, вам нужно будет обработать цифры, которые поставщик услуг будет посылать вам \(DID или номер телефона\). Номера DNIS и DID не должны совпадать, но, как правило, будут. Ранее провайдер обычно спрашивал, в каком формате вы хотите получать цифры. В настоящее время оператор VoIP, как правило, говорит вам в каком формате будет отправлять, и вы должны принять его. Два распространенных формата: DNIS \(который по сути является цифрами вызываемого DID\) или E.164, что означает, что они будут включать код страны с номером.

В диалплане входящий канал связывается с контекстом, который будет знать, как обрабатывать входящие цифры. В качестве примера, это может выглядеть примерно так:

```text
[from-pstn]
exten => 4165550100,1,Goto(sets,100,1)
exten => 4165550101,1,Goto(sets,101,1)
exten => 4165550102,1,Goto(sets,102,1)
exten => 4165550103,1,Goto(sets,103,1)
exten => 4165554321,1,Goto(main-menu,${EXTEN},1)
exten => 4165559876,1,VoiceMailMain() ; удобный ход для прослушивания голосовых сообщений
exten => i,1,Verbose(2,Incoming call to invalid number)
```

В контексте `number-muppng` вы явно перечисляете все идентификаторы DID, которые ожидаете принимать, а также недопустимый обработчик для всех DID, которые не перечислены \(вы можете отправлять недопустимые номера в приёмную или в автосекретарь или даже в некоторый контекст, который воспроизводит недопустимое оповещение\).

Теперь мы готовы обсудить, как настроить транки для передачи вашего внешнего трафика.

### Configuring SIP Trunks

SIP is far and away the most popular of the VoIP protocols—so much so that the terms VoIP and SIP have almost come to mean the same thing. In previous editions of this book, we’ve looked at some of the other protocols that were popular at the time \(primarily IAX2 and H.323\), but for this edition there’s no real reason anymore to discuss anything but SIP. The channel drivers for those older protocols are still available in Asterisk, but they’re no longer supported.

The SIP protocol is peer-to-peer and does not really have a formal trunk specification. This means that whether you are connecting a single phone to your server or connecting two servers together, the SIP connections will be similar. Having said that, there are some differences in the style of how these resources can be configured, and there will definitely be a difference in how your dialplan handles routing across trunks.

#### Connecting an Asterisk system to a SIP provider

It is quite common to use the same ITSP carrier for termination and origination, but be aware that the two processes are unrelated to each other. If calls going in one direction pass your testing, that doesn’t mean calls in the other direction are OK. If you change configuration, test routing both in and out, every time.

Many carriers will provide sample configurations for Asterisk. Unfortunately, these documents generally refer to the older chan\_sip driver, which has been deprecated. Digium has designed a PJSIP wizard that is intended to greatly simplify carrier configuration. You can still configure ITSP trunks using the exact same methods we’ve shown before for configuring other endpoints \(creating records in ps\_endpoint, ps\_aors, ps\_auths, and so forth\), but rather than hash over all that again, we are going to take a look at the wizard, since it consolidates several components into a single configuration file. We have found that since user endpoints change often, and carrier endpoints seldom do, it’s often useful to configure carriers in a configuration file rather than in the database.

Before any config can be created, however, it’s important to determine how the carrier will interact with your system. There are two fundamental models we have seen:

Password-based authentication, including registration[15](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407656840)

This is common in smaller carriers focused on the small-business market. This is also the type of service you would get if you were simply registering a SIP phone directly to a service.

IP-based authentication

No password; no registration. This is more common with carriers that provide bulk trunking services to larger enterprises and resellers. \(Typically these will also come with some sort of minimum commitment in terms of volume.\) You will be expected to have solid SIP and networking skills.

These are not hard-and-fast rules, but they are the most common in our experience.

So there are two ways we might configure an ITSP in the /etc/asterisk/pjsip\_wizard.conf file.

First, if the carrier uses an IP address–based authentication, they will expect you to send your traffic from a static IP address \(and should your address change, you will need to inform them so they can reconfigure their equipment\). Your pjsip\_wizard.conf file could then look something like this:

```text
; ITSP uses IP address-based authentication
[itsp-no-auth]
type=wizard
remote_hosts=itsp.example.com
endpoint/context=pstn-in
endpoint/allow = !all,ulaw,g722
sends_registrations=no
accepts_registrations=no
sends_auth=no
accepts_auth=no
```

Alternatively, if your IP address changes frequently \(or your carrier requires this method\), you can have your system register to the carrier \(which will require you to send authentication credentials to prove it’s really you\). Your calls will typically also be required to authenticate:

```text
[itsp-with-auth]
type=wizard
remote_hosts=itsp.example.com
endpoint/context=pstn-in
endpoint/allow = !all,ulaw,g722
sends_registration=yes
accepts_registrations=no
sends_auth=yes
accepts_auth=no
outbound_auth/username=itsp_provided_username
outbound_auth/password= itsp_provided_password
```

Note that the names \[itsp-no-auth\] and \[itsp-with-auth\] have no built-in meaning to Asterisk. They become the PJSIP channel names to which you send your calls.

**Configure trunks for termination**

The PJSIP wizard has created the channel definitions we require for our carrier. To send a call, we only need to make a minor change to the \[globals\] section of our extensions.conf file, as follows:

```text
[globals]
UserA_DeskPhone=PJSIP/0000f30A0A01
UserA_SoftPhone=PJSIP/SOFTPHONE_A
UserB_DeskPhone=PJSIP/0000f30B0B02
UserB_SoftPhone=PJSIP/SOFTPHONE_B
TOLL=PJSIP/itsp-no-auth
LOCAL=${TOLL}
;OR
;TOLL=PJSIP/itsp-with-auth
;LOCAL=${TOLL}
```

**Configuring trunks for origination**

For your incoming calls, you’ll need a context in your /etc/asterisk/extensions.conf file that matches the context specified for the ITSP channel. Let’s assume we have two NANP DIDs, 4169671111 and 4167363636, and place the required code above the \[sets\] context:

```text
TOLL=PJSIP/itsp-no-auth
LOCAL=${TOLL}
;OR
;TOLL=PJSIP/itsp-with-auth
;LOCAL=${TOLL}
[pstn-in]
exten => 4169671111,1,Dial(sets,100,1)
exten => 4167363636,1,Dial(sets,101,1)
[sets]
exten => 100,1,Dial(${UserA_DeskPhone})
```

In a small system, this is fairly easy to administer. In a larger system, you’d want to put the DIDs into a table in your database, and have the dialplan look up the required target. We’ll be diving into databases a bit more later in the book.[16](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407641272)

That’s the gist of it as far as carrier interconnection is concerned. It can seem very complicated to set this up because there are a lot of options, but at a high level it’s fairly straightforward. Problems are usually found to be minor configuration mismatches. Be methodical, and please, please, please be paranoid about security!

## Emergency Dialing

In North America, people are used to being able to dial 911 in order to reach emergency services. Outside of North America, well-known emergency numbers are 112 and 999. If you make your Asterisk system available to people, you are obligated \(in many cases regulated\) to ensure that calls can be made to emergency services from any telephone connected to the system \(even from phones that otherwise are restricted from making calls\).

One of the essential pieces of information the emergency response organization needs to know is where the emergency is \(e.g., where to send the fire trucks\). In a traditional PSTN trunk, this information is already known by the carrier and is subsequently passed along to whatever local authority handles these tasks \(in Canada and the US, these are called Public Safety Answering Points, or PSAP\). With VoIP circuits things can get a bit more complicated, by virtue of the fact that they are not physically tied to any geographical location.

You need to ensure that your system will properly handle emergency calls from any phone connected to it, and you need to communicate what is available to your users. As an example, if you allow users to register to the system from softphones on their laptops, what happens if they are in a hotel room in another country, and somebody dials 911?[17](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407626504)

The dialplan for handling emergency calls does not need to be complicated. In fact, it’s far better to keep it simple. People are often tempted to implement all sorts of fancy functionality in the emergency services portions of their dialplans, but if a bug in one of your fancy features causes an emergency call to fail, lives could be at risk. This is no place for playing around. The \[emergency-services\] section of your dialplan might look something like this:

```text
[emergency-services]
exten => 911,1,Goto(dialpsap,1)
exten => 9911,1,Goto(dialpsap,1) ; some people will dial '9' because
 ; they're used to doing that from the PBX
exten => 999,1,Goto(dialpsap,1)
exten => 112,1,Goto(dialpsap,1)
exten => dialpsap,1,Verbose(1,Call initiated to PSAP!)
 same => n,Dial(${LOCAL}/911) ; REPLACE 911 HERE WITH WHATEVER
 ; IS APPROPRIATE TO YOUR AREA
[internal]
include => emergency-services ; you have to have this in any context
 ; that has users in it
```

In contexts where you know the users are not on-site \(for example, remote users with their laptops\), something like this might be best instead:

```text
[no-emergency-services]
exten => 911,1,Goto(nopsap,1)
exten => 9911,1,Goto(nopsap,1) ; for people who dial '9' before external calls
exten => 999,1,Goto(nopsap,1)
exten => 112,1,Goto(nopsap,1)
exten => nopsap,1,Verbose(1,Call initiated to PSAP!)
 same => n,Playback(no-emerg-service) ; you'll need to record this prompt
[remote-users]
include => no-emergency-services
```

In North America, regulations have obligated many VoIP carriers to offer what is popularly known as E911.[18](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407618072) When you sign up for their services, they will require address information for each DID that you wish to associate with outgoing calls. This address information will then be sent to the PSAP appropriate to that address, and your emergency calls should be handled the same way they would be if they were dialed on a traditional PSTN circuit.

Суть в том, что вы должны убедиться, что телефонная система, которую вы создаете, обрабатывает экстренные вызовы в соответствии с местными правилами и ожиданиями пользователей.

## Вывод

Обычно прогнозируется, что ТфОП в конечном итоге полностью исчезнет. Однако, прежде чем это произойдет, потребуется широко используемый и надежный распределенный механизм, который позволит организациям и отдельным лицам публиковать адресную информацию, чтобы их можно было найти. Любая голосовая технология, которая не использует PSTN, в настоящее время является либо запатентованным продуктом стен-сада, либо игровой площадкой спамеров и преступников. Мы подозреваем, что ТфОП будет сущесвтвовать еще некоторое время, и если это так, то возникновение и завершение должны быть частью вашей системы Asterisk.

[1](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407857960-marker) In a key system, each line has a corresponding button on each telephone, and lines are accessed by pressing the desired line key.

[2](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407852440-marker) You can name these anything you wish.

[3](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407848792-marker) For more information on pattern matches, see [Chapter 6](glava-06.md).

[4](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407792344-marker) We should note, however, that we’ve written extensively on the subject in the past, and that body of work has been released under Creative Commons licensing, and is freely available.

[5](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407778472-marker) There’s also a circuit used in Japan called a J-1, which is most simply described as a 24-channel E1.

[6](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407773192-marker) We would again like to note that we’ve written extensively about digital circuits and DAHDI in previous editions, and that body of work has been released under Creative Commons licensing, and is freely available. Also, Sangoma/Digium provide detailed instructions on how to install and configure their PSTN cards. If you are looking to deploy this technology, please enlist the services of a professional technical resource. This stuff is complex and nuanced, and is not something you’re going to enjoy playing with if you haven’t had some sort of previous experience. It is not necessary to learning or understanding Asterisk.

[7](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407767752-marker) When we say “lengthy” we mean that in relation to other electronic technologies.

[8](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407766216-marker) Just try to imagine if your telephone number could be spammed the way your email address is. The fact that the PSTN is regulated, costs money to use, and controls the telephone numbers has served to limit the plague of spam that email has suffered.

[9](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407758680-marker) [The Wikipedia page on network address translation](http://bit.ly/2InpK6S) is comprehensive and useful. For more information about different types of NAT, and how NAT operates in general, start there.

[10](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407755912-marker) SIP is not the only protocol to use RTP to carry media streams.

[11](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407725320-marker) Whether it is the best solution is still up for debate.

[12](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407704584-marker) And perhaps even use them that way in conversation, since many people are confused by these terms, and few will admit it when you’re talking to them.

[13](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407692712-marker) Trust us, Jim Van Meggelen worked with this stuff for many years before getting into VoIP.

[14](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407677720-marker) In traditional PBXs, the purpose of DIDs was to allow connection directly to an extension in the office. Many PBXs could not support concepts such as number translation or flexible digit lengths, and thus the carrier had to pass the extension number, rather than the number that was dialed \(which was also referred to as the DNIS number, from Directory Number Information Service\). For example, the phone number 416-555-1234 might have been mapped to extension 100, and thus the carrier would have sent the digits 100 to the PBX instead of the DNIS of 4165551234. If you ever replace an old PBX with an Asterisk system, you may find this translation in place, and you’ll need to obtain a list of mappings between the numbers that the caller dials and the numbers that are sent to the PBX. It was also common to see the carrier only pass the last four digits of the DNIS number, which the PBX then translates into an internal number. With VoIP trunks this will seldom be the case, but be aware that it is possible.

[15](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407656840-marker) Remember that registration is simply a mechanism whereby a SIP endpoint tells a registrar server where it is located. This is useful if your IP address changes, as might be the case on a consumer or small-business type of internet connection \(such as DSL or cable\).

[16](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407641272-marker) A table to handle this would simply need a field for the DID, and three more for the target context, extension, and priority.

[17](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407626504-marker) Don’t assume this can’t happen. When somebody calls 911, it’s because they have an emergency, and it’s not safe to assume that they’re going to be in a rational state of mind. A recording that tells your softphone users what address the system is going to be sending to the PSAP may clue them in to the fact that the fire trucks aren’t going to be sent to where they’re needed. \(“This telephone is registered to our Toronto system. Emergency services will be sent to our office at 301 Front St W. Press 1 to proceed with this call.”\).

[18](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch07.html%22%20/l%20%22idm46178407618072-marker) It’s not actually the carrier that’s offering this; rather it’s a capability of the PSAP. E911 is also used on PSTN trunks, but since that happens without any involvement on your part \(the PSTN carriers handle the paperwork for you\), you are generally not aware that you have E911 on your local lines.

